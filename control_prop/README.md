# BBM2 制御システム

Q BBM2のJetson上でのプロペラ制御プログラムと設定情報をまとめたリポジトリ．

## プロペラ制御プログラム

### 共通仕様

- 起動時に**ESCのキャリブレーション音**が鳴る．終了後に入力受付開始．
- 一定時間操作がないと警告音が鳴ります．
  - `Ctrl + C`で終了し，再起動で警告音は止まる．
- 音がうるさい場合はESCの**赤いコネクタ**を抜いても構わない．
  - ※ ただし，PWMドライバがESCから電源を取得しているため，制御プログラムは動作しなくなる．

---

### `fan_test.py`

手動で各モータを制御するためのスクリプト．
PWMポートとモータの対応確認や個別動作確認に使用．

```bash
cd ~/your-project/control_prop/script
python fan_test.py
```

#### キーマップ

| 入力      | 説明                                 |
|-----------|--------------------------------------|
| `0`~`7`   | 各PWMポートのモータを低速回転        |
| `+0`~`+7` | 各モータをフルスロットル             |
| `-0`~`-7` | 各モータを停止                       |
| `h`       | 全モータをフルスロットル             |
| `l`       | 全モータを停止                       |
| `w/a/s/d` | 並進方向モータの低速回転             |
| `z`/`x`   | `z`: 左回転 (反時計) / `x`: 右回転 (時計) |

---

### `controller.py`

ゲームコントローラで正面姿勢のまま制御．

```bash
cd ~/your-project/control_prop/script
python controller.py
```

#### キーマップ

| 入力         | 説明                     |
|--------------|--------------------------|
| 左スティック | 並進（XY平面）          |
| 右スティック | 旋回（Z軸）             |
| 十字キー     | 固定値並進（XY平面）    |
| LB/RB        | 固定値旋回（Z軸）       |

---

### `controller_facedown.py`

ゲームコントローラで**顔が下向きの状態**で制御．

```bash
cd ~/your-project/control_prop/script
python controller_facedown.py
```

---

## I2C 関連

### Tips

```bash
# 各ピンの機能確認
sudo /opt/nvidia/jetson-io/jetson-io.py

# Jetsonでは3番・5番ピンが I2C8（バス番号7）に設定済み
# 接続済みデバイス確認（Jetsonは -r オプションが必要）
sudo i2cdetect -y -r 7
```

---

### アドレスマップ

#### Jetson (I2C8)

| アドレス | デバイス               |
|----------|------------------------|
| `0x60`   | PWMドライバ（モータ制御） |

#### Raspberry Pi

| アドレス | デバイス     |
|----------|--------------|
| `0x61`   | 電流センサ   |
| *未定*   | CO₂センサ    |

---

## インストール手順

Jetson環境で以下のコマンドを実行：

```bash
pip install Adafruit_PCA9685
pip install package
```
